©2016  **云智易**物联云平台（http://www.xlink.cn）

# XLINK 数据端点概览

* 该文档主要介绍平台数据端点的概念，功能，以及开发者如何使用数据端点。
* 该文档面向使用XLINK平台开发智能硬件的开发者，包括硬件开发者、APP开发者以及平台使用者。

## 概览

### 数据端点是什么
	
* 数据端点是对设备运行状态的某种特征值或者某种动作的抽象。 例如对于灯设备，特征值:灯的亮度，动作:灯的开或关。

### 数据端点能做什么事情

* 数据端点是平台与设备进行交互的基础/核心/桥梁，相当于沟通协议。

* 控制设备。 以灯设备为例, 灯拥有者通过向平台发送代表开灯指令，平台向设备发送要设置“开关”数据端点值，设备接收到平台发送值进行解析从而执行操作，诸如此类还有控制灯的亮度等等。

* 记录设备当前运行状态--虚拟设备。 设备每上报一次数据端点，都会映射成虚拟设备的一个特征值，用户可以通过请求虚拟设备信息来知道设备当前所处运行状态。

* 记录设备历史运行状态--快照。 设备运行状态的记录通过向平台上报数据端点值, 平台接收到上报数据端点值后会依据快照规则将其记录起来, 此为设备快照, 针对快照，即可查询设备所有的运行记录。

* 设备运行状态分析--统计。 基于快照保存的设备运行状态即是设备数据端点值，平台会依照统计规则进行设备行为分析。 以太阳能设备为例，可以统计分析出太阳能每天产生能量峰值，总值等等。

* 设备状态监控--告警通知。 设备上报运行状态，依照告警通知规则，进行触发告警。 以灯设备为例，假如设备上报灯的亮度数据端点值为百分之八十，而告警规则设置其阈值为百分之七十，此时会通过不同的渠道通知灯设备拥有者(邮件/收集状态栏推送等)


### 数据端点的限制

* 支持类型:布尔类型, 单字节, 短整型, 整型, 浮点型, 字符串, 字节数组, 16位整型无符号, 32位整型无符号

* 个数限制:200

* 公共数据端点:所有设备在xlink平台都应该具有的数据端点

## 虚拟设备

### 什么是虚拟设备

* 虚拟设备是设备当前所有运行状态特征值\动作的以及待执行操作的抽象集合。 具体地说，记录着设备当前所有数据端点的值，在线状态，待执行用户指令等等。

### 虚拟设备能做什么事情

* 获取用户设备最新运行状态。 以空气加湿器设备为例，设备拥有者获取该设备最新的风速，由于虚拟设备会记录设备上报的最新特征值，此时用户不需要向设备发送获取指令，只需要向平台的虚拟设备获取即可，即使设备当前不在线也可以获得设备最近的运行状态，减少了用户--平台--设备三者之间的网络交互传输。

* 保存设备执行动作。 以空气加湿器设备为例，设备拥有者希望远程控制加湿器，由于各种原因诸如设备网络不在线等等导致不能即时控制设备，此时用户亦可以通过虚拟设备将用户的相关指令保存起来，待设备恢复连接平台自动推送相关指令到设备，从而达到控制设备。

* 作为定时快照数据来源。 定时快照用于保存设备阶段性的运行状态特征值记录，数据来源于虚拟设备记录的设备运行状态。

### 为什么要用虚拟设备

* 获取设备状态时, 较少用户与设备的交互。 虚拟设备是设备的一个影子，完全可以代表设备的所有动作，可以真实反馈设备的运行状态，因此只需要向虚拟设备获取设备状态，不需要与设备交互。

* 虚拟设备是设备和设备拥有者之间的信息交互中间站。 设备接入物联平台的一个重要原因即是设备拥有者及时对设备的控制，通过虚拟设备不论设备是否在线都能实现对设备的及时控制。

## 设备调试

### 如何调试设备

* 条件:
	
	* 设备接入平台
	* 在管理台定义代表设备特征值的数据端点
	* 设备当前在线

* 步骤:
	
	* 厂商需要在云智易企业管理平台注册一个企业账号，登录到管理台，添加一个产品
	* 开发平台-->调试设备所属产品-->数据端点-->添加数据端点
	* 开发平台-->调试设备所属产品-->设备调试
	* 通过mac地址搜索要调试的设备
	* 点击要调试设备，如若设备在线既可以看到设备当前各项指标值(数据端点值)
	* 对于不同类型指标(数据端点)可以通过输入框, 单选框, 滚动条对其进行设置各项指标值，从而实现调试。

### 设备调试的使用场景

* 设备测试阶段，可提供测试人员进行设备测试，提升测试效率以及开发人员开发效率。

* 设备售后技术支持，可以通过设备调试功能对设备当前各项指标进行评估得出设备障碍出现原因，亦可以进一步设置设备当前指标值，从而实现远程处理设备障碍。

## 告警通知

### 数据端点与告警通知的关系

* 本质而言，数据端点触发告警通知是对设备状态某项或者几项特征值的实时监控。

* 告警通知是XLINK平台一项重要的模块服务，用于告知设备拥有者或者企业成员企业当前设备由于某项指标所触发的告警通知，数据端点只是触发告警通知的一种重要方式，另一种重要方式是设备状态。

* XLINK平台规则引擎会实时依据企业设置的数据端点类告警规则，对设备上报的数据端点指标值进行分发处理。 对于符合告警规则触发告警条件的数据端点指标值即会产生告警通知，如某个数据端点指标值大于/小于/等于某个值时，通常这些值应该属于设备的阈值。 告警通知内容/告警通知方式/告警通知范围可在告警规则中进行配置。

### 如何设置告警规则

* 一.条件

	* 在管理台定义代表设备特征值的数据端点
	* 如需对APP进行APN推送, 须在开发平台-->应用管理-->对应APP上传p12证书和密码
	* 如需对APP进行GCM推送, 须在开发平台-->应用管理-->对应APP设置谷歌平台的server api key
	* 如需对告警通知进行微信推送，须将微信的模板ID填入对应的微信APP

* 二.步骤

	1. 厂商需要在云智易企业管理平台注册一个企业账号，登录到管理台，添加一个产品。

	2. 在产品的数据端点设置中，按照产品需求，添加一个或多个数据端点，用于描述和收集产品下设备的运行状态特征值。
		
		* 数据端点由"索引"，"类型"，"值"三个要素组成。一个设备可以最多添加200个数据端点，数据端点的索引值不需要按顺序排放，但是数据端点的索引值不能重复。
    	
		* 数据端点支持布尔类型/单字节/短整型/整型/浮点型/字符串/字节数组/16位整型无符号/32位整型无符号, 以满足设备上报状态的需求。
    	
		* 设备硬件开发工程师，在设备端开发时，一定要遵守管理台上已经设置好的数据端点的"索引"、"类型"完成数据端点的上报，这样平台才可以正确解析设备的运行状态，完成后续工作。
 
	3. 当厂商完成数据端点的设置后，便可以在产品的“通知与告警”服务中，添加告警规则。告警规则由"告警条件"、"告警内容"、"告警等级"、"通知方式"、"可见范围"几个关键属性组成。
    	
		* 告警条件：指的是当设备的数据端点指标值变化满足到既定条件时，便触发告警或通知。
       	
		* 告警内容：指的是当告警被触发后，需要通知的具体内容。
        
		* 通知方式：支持通知到短信、邮箱、应用内推送和APN推送。
			* 短信：当告警触发后，通知到企业成员的手机，注意，暂时不支持通知到用户手机。

			* 邮箱：当告警触发后，通知到企业成员的邮箱，注意，暂时不支持通知到设备用户的邮箱。
            
			* 应用程序内推送：当用户的APP订阅了这个设备，当设备触发了告警，告警内容就会通过到所有在线的APP内。不在线的APP通知不到，这时就需要使用到APN推送了。
            
			* APN推送：针对不在线的APP如何能够即时收到设备告警，云智易引入了APN（Apple Push Notify Service）。当选中了APN通知，设备告警会推送到对应的iOS APP上，即便APP没有上线， 也能收到告警内容。APN的配置，在后面会进行说明。针对Android APP，由于Android APP具有可以长期驻守后台的便利，Android APP可以直接通过应用程序内推送消息完成告警的功能而不用引入类似APN推送的功能。
            
	4. 厂商还可以通过管理台的告警服务，查看所有设别的历史告警消息以及告警信息统计信息。

* 三.消息模版设置
	
	1. 云智易的消息通知在通常情况下，会直接将厂商设置好的告警消息或通知直接发送出去。如厂商在一个告警规则中的告警内容设置为“设备上线了”，那么在设备上线的时候，通知服务将会直接把“设备上线了”这个消息通知到所有设定好的目标中。

	2. 为了满足更复杂的消息内容通知需求，云智易提供了消息模板的功能。厂商可以按照一定的消息模板设置，将更复杂，有变量的消息通知到目标上。

	3. 消息模板规则：
    	* 厂商在设置消息内容的时候，需要带上"{value}"参数，其中 "{value}"为需要接口替换的变量；
    	* 具体场景：
        	* 当厂商设置了一个温度端点告警阀值为50度，并且其告警内容设置为"注意！您的设备温度达到了{value}度。"，那么当这个设备的温度端点值达到56度时，推送给用户的告警内容就会是"注意！您的设备温度达到了56度。"
        	
        	* 当厂商设置了一个字符窜的数据端点，设置告警规则为字符串不为空或者大于小于另外一个字符串，并且其告警内容设置为"注意！您的{value}发生了异常。"，那么当这个设备上报的数据端点数据为"一号门磁"，推送给用户的告警内容就会是"注意！您的一号门磁发生了异常。"
        	
        3. 并且针对字符串类型数据端点的告警，平台还支持复杂的模版规则，如下：
        
            * 一个字符窜的数据端点，设置告警规则为字符串不为空或者大于小于另外一个字符串，其告警内容设置为"注意！您的｛device}被{option}。"。
            
			* 设备上报的字符数据若为如下格式的JSON数据: ***{"xn":{"device": "大门门磁”,"option": "打开"}}***，那么告警内容就会是: ***注意！您的大门门磁被打开。***，其中json数据中，“xn” Object为保留关键字，表示里面内容为需要匹配消息模版的。”device”，”option"两个Object Name表示需要将内容替换消息模版中的{device}和{option}。

## 设备快照

### 什么是设备快照

* 设备快照是指设备运行历史某个时刻各项特征值的数据备份集合。

### 设备快照能够做什么

* 作为产品/设备统计分析数据来源。 以储能系统为例，利用快照中的即时快照数据作为来源，可以统计出该产品总触电量，亦可以分析计算出储能系统各项指标值的最大/最小/平均/总值等等。

* 设备行为分析数据来源。 如用于分析设备发生故障临界值，得出临界值有助于提升产品性能。 以灯设备为例，如灯传感器某项特征值达到某个阈值时即会报废，这个阈值找出是有助于产品设计。

* 映射设备整个生命周期, 可以通过设备快照折射出设备从出厂使用到设备报废整个生命周期，达到厂商对设备的有效监控。

### 三种数据快照的区别

* 定时快照：不管设备是否上报了数据端点，只要是上线的设备，每隔固定时间都会存储。 设备上线，固定时间，不管是否上报。

* 变化存储：不管间隔，设备上报的数据端点特征值有变化时进行存储。 设备上线，不固定时间，与上一次相比发生变化

* 即时存储：设备上报数据端点特征值立即存储。 设备上线，不固定时间，上报即存储。

### 企业如何使用数据快照

* 条件

	* 数据快照是XLINK平台提供的一项增值服务，如需开通数据快照服务请联系[平台商务](http://www.xlink.cn/about.html "平台商务")
	
	* 添加需要进行快照产品的数据端点特征指标

* 步骤

	* 厂商需要在云智易企业管理平台注册一个企业账号，登录到管理台，添加一个产品。

	* 在产品的数据端点设置中，按照产品需求，添加一个或多个数据端点，用于描述和收集产品下设备的运行状态特征值。

	* 联系平台商务开通数据快照服务。

	* 快照配置，开发平台-->数据服务-->数据快照-->添加快照配置，配置快照所属产品/快照类型/快照名称/快照涉及数据端点，如是定时快照类型，则须配置定时快照周期。

## 设备快照统计

### 快照统计能够做什么事情

* 快照统计数据来源: 变化快照和即时快照。

* 快照统计依赖: 快照统计规则。

* 统计不同粒度不同维度的设备数据端点特征值。 以储能系统为例，统计出每个储能系统的某个数据端点特征(储能量)在不同粒度(Hour/Day/Week/Month/Year)的不同维度(MAX/MIN/SUM/AVG)值，例如储能量每天的最大值。

* 统计产品某一特征值的设备排名。 以储能系统为例，可以对产品下某个数据端点特征值(储能量)按不同维度(MAX, MIN, SUM, AVG)进行不同粒度(Hour/Day/Week/Month/Year)设备排名，例如储能量每天最大值前10的设备列表。

* 统计某设备某一特征值在产品下的排名。 以储能系统为例，可以统计出某一储能系统某个数据端点特征值(储能量)不同维度(MAX/MIN/SUM/AVG)不同粒度(Hour/Day/Week/Month/Year)在产品下的排名，例如某储能系统每个月最大储能量在产品下的排名。


### 什么是粒度、什么是维度

* 粒度:统计规则目前支持粒度有五种, 小时/天/周/月/年(Hour/Day/Week/Month/Year)。 即是以小时/天/周/月/年为一个周期闭环进行统计, 确定了统计的时间周期。

* 维度:统计规则目前支持维度有四种, 最大值/最小值/平均值/总值(MAX/MIN/SUM/AVG) 即是以最大值/最小值/平均值/总值为统计目标。

### 如何使用快照统计数据

* 条件

	* 数据快照统计是基于数据快照而进行的一项增值服务，因此需要进行数据快照统计必须先开通数据快照服务，如需开通数据快照服务请联系[平台商务](http://www.xlink.cn/about.html "平台商务")
	
	* 快照统计只针对单字节型, 短整型, 整型, 浮点型, 16位整型无符号, 32位整型无符号类型数据端点进行统计

* 步骤

	* 厂商需要在云智易企业管理平台注册一个企业账号，登录到管理台，添加一个产品。

	* 在产品的数据端点设置中，按照产品需求，添加一个或多个单字节型, 短整型, 整型, 浮点型, 16位整型无符号, 32位整型无符号类型数据端点，用于描述和收集产品下设备的运行状态特征值。

	* 联系平台商务开通数据快照服务。

	* 添加快照规则，开发平台-->数据服务-->数据快照-->添加快照配置，配置快照所属产品/快照类型/快照名称/快照涉及数据端点，如是定时快照类型，则须配置定时快照周期, 涉及数据端点必须有单字节型/短整型/整型/浮点型/16位整型无符号/32位整型无符号类型中的其中一种或多种，否则无法进行统计。

	* 添加统计规则，开发平台-->数据服务-->统计规则-->添加统计规则，配置规则名称/规则描述/依赖快照规则/统计粒度/统计维度。

## 附录

### 1.对应的API

* 以下列出了和数据端点相关的平台部分API，不包括全部，开发者可以到平台的文档中心查看更全面的接口文档。

**接口概览**

1. [用户获取设备快照](#user_get_device_snapshot)
2. [设备快照数据端点统计](#statistics_snapshot_rule)
3. [产品下数据端点统计排名](#statistics_snapshot_rank)
4. [产品下获取设备数据端点的排名](#statistics_snapshot_device_rank)
5. [产品下数据端点分类统计](#statistics_datapoint_classify)
6. [产品维度数据端点统计](#statistics_product_datapoint)
7. [获取虚拟设备数据](#corp_get_vdevice_info)
8. [批量获取虚拟设备数据](#corp_get_vdevice_list)


### <a name="user_get_device_snapshot">1 用户获取设备快照</a>

#### **Request**

*URL*

```
POST /v2/product/{product_id}/device/{device_id}/snapshot
```

*Header*

```
Content-Type:application/json
Access-Token:"企业调用凭证"
```

*Content*

```
{
  "offset": "请求纪录的偏移量",
  "limit": "请求数量",
  "date": {
    "begin" : 通过时间查询，开始时间,
    "end" : 通过时间查询，结束时间
  },
  "rule_id":"快照规则id"
}
```

| 字段 | 是否必须 | 描述 |
| --- | --- | --- |
| offset | 是 | 请求纪录的偏移量 |
| limit | 是 | 请求数量 |
| date | 否 | 是否通过时间作为查询的过滤条件 |
| date.begin | date节点中必须 | 查询开始时间,时间戳,单位毫秒 |
| date.end | date节点中必须 | 查询结束时间,时间戳,单位毫秒|
| rule_id | 否 | 快照规则id

#### **Response**

*Header*

```
HTTP/1.1 200 OK
```

*Content*

```
{
  "count" : 获取的设备快照个数,
  "list" :
  [
    {
      "id" : "设备快照ID",
      "device_id" : "设备ID",
      "cm_id" : "登录CM服务器ID",
      "ip" : "登录IP",
      "online" : "是否在线",
      "last_online" : "上次登录时间,例：2015-10-09T08:15:40.843Z",
      "last_offline" : "上次离线时间,例：2015-10-09T08:15:40.843Z",
      "last_update" : "上次数据端点变化时间,例：2015-10-09T08:15:40.843Z",
	  "snapshot_date" : 快照时间,例：2015-10-09T08:15:40.843Z",
	  "cause_list":["引起快照的数据端点快照下标","引起快照的数据端点快照下标"],
	  "rule_id":快照规则id",
      "0" : 数据端点值,
      "1" : 数据端点值
    },
    {...}
  ]
}
```

| 字段 | 是否必须 | 描述 |
| --- | --- | --- |
| count | 是 | 获取的条目个数 |
| list | 是 | 获取的快照列表 |
| list._id | 是 | 设备快照ID |
| list.device_id | 是 | 设备ID |
| list.cm_id | 是 | 登录CM服务器ID |
| list.ip | 是 | 登录IP |
| list.online | 是 | 是否在线 |
| list.last_online | 是 | 上次登录时间 |
| list.last_offline | 是 | 上次离线时间 |
| list.last_update | 是 | 上次数据端点变化时间 |
| list.rule_id | 是 | 数据快照规则id |
| list.数据端点索引 | 否 | 数据端点值 |
| list.cause_list | 是 |　引起快照的数据端点快照下标 | 

### <a name="statistics_snapshot_rule">2.设备快照数据端点统计</a>

* 依据快照规则下的某个统计规则对设备数据端点进行统计, 包括不同粒度的max, min, avg, sum；
* 统计粒度包括小时，自然日，自然周，自然月，自然年；
	* 小时为每小时整点统计一次；
	* 自然日为当天的00:00:00到23:59:59；
	* 自然周为每周一的00:00:00到每周日的23:59:59；
	* 自然月为每个自然月的第一天的00:00:00到最后一天的23:59:59；
	* 自然年为每个自然年的第一天的00:00:00到最后一天的23:59:59；
	
**Request**

URL
	
	POST /v2/statistics/snapshot/{snapshot_id}/snapshot_statistic/{snapshot_statistic_id}/{device_id}

Header

	Content-Type:"application/json"
	Access-Token:"调用凭证"

Content

	{
	    "datapoint": [
	        "数据端点1",
	        "数据端点2",
	        "数据端点3"
	    ],
	    "fineness": "统计粒度",
	    "date_start": "快照统计数据开始时间, 格式为yyyy-MM-dd'T'HH:mm:ss.SS'Z'",
	    "date_end": "快照统计数据结束时间, 格式为yyyy-MM-dd'T'HH:mm:ss.SS'Z'"
	}

| 字段 | 是否必须 | 描述 |
| --- | --- | --- |
| datapoint | 是 | 要进行的数据端点列表, 数据端点必须在统计规则中有进行设置, 目前仅支持单个数据端点统计 |
| fineness | 是 | 统计粒度, 见[附录](#snapshot_statistic_rule_fineness)。 |
| date_start | 是 | 快照统计数据开始时间 |
| date_end | 是 | 快照统计数据结束时间 |

**Response**

Header

	HTTP/1.1 200 OK

Content

	{
	    "fineness": "统计粒度",
	    "list": [
	        {
	            "datapoint": "数据端点下标",
	            "mode": "统计方式, avg, max, min, sum",
	            "value_list": [
	                {
	                    "date": "2015-09-28'T'00:00:00'Z'",
	                    "value": "maxdp"
	                },
	                {
	                    "date": "2015-09-28'T'00:00:00'Z'",
	                    "value": "maxdp"
	                }
	            ]
	        }
	    ]
	}

| 字段 | 是否必须 | 描述 |
| --- | --- | --- |
| fineness | 是 | 统计粒度, 见[附录](#snapshot_statistic_rule_fineness)。 |
| datapoint | 是 | 数据端点下标 |
| mode | 是 | 数据端点统计方式, 见[附录](#snapshot_statistic_rule_mode) |
| value_list | 是 | 数据端点某个统计方式的统计数值列表。所返回的条目个数，为请求所设定的粒度决定，如请求一天之内每小时的数据，那么就会返回24条，每小时一条的数据。若请求一年之内每月的数据，那么就会返回12条数据，每月一条； |
| date | 是 | 某种统计维度的自然开始时间: <br>如统计维度是小时则为2015-09-28 01:00:00, 统计计算的是2015-09-28 01:00:00 到 2015-9-28 01:59:59 之间的数据；<br>如统计维度是天则为2015-09-28 00:00:00, 统计计算的是2015-09-28 00:00:00到2015-9-28 23:59:59 之间的数据；<br>如统计维度是月则为某个月的第一天2015-09-01 00:00:00, 统计计算的是2015-09-01 00:00:00到2015-9-30 23:59:59 之间的数据；|
| value | 是 | 统计维度下的统计数值 |


### <a name="statistics_snapshot_rank">3.产品下数据端点统计排名</a>

	产品下设备在一个统计维度某段时间数据快照值排名统计(前几名,后几名)
	
**Request**

URL
	
	POST /v2/statistics/snapshot/{snapshot_id}/snapshot_rank/{snapshot_statistic_id}

Header

	Content-Type:"application/json"
	Access-Token:"调用凭证"

Content

	{
	    "datapoint": [
	        "数据端点1",
	        "数据端点2",
	        "数据端点3"
	    ]
	    "mode": "端点统计方式",
	    "date_start": "快照统计数据开始时间, 格式为yyyy-MM-dd'T'HH:mm:ss.SS'Z'",
	    "date_end": "快照统计数据结束时间, 格式为yyyy-MM-dd'T'HH:mm:ss.SS'Z'",
	    "sort": "排名方式, 1:升序, -1:倒序",
	    "limit": "前几",
		"fineness":"统计粒度"
	}

| 字段 | 是否必须 | 描述 |
| --- | --- | --- |
| datapoint | 是 | 要进行的数据端点列表, 数据端点必须在统计规则中有进行设置, 目前仅支持单个数据端点统计 |
| mode | 是 | 数据端点统计方式, 见[附录](#snapshot_statistic_rule_mode) |
| date_start | 是 | 快照统计数据开始时间 |
| date_end | 是 | 快照统计数据结束时间 |
| sort | 是 | 排名方式, 1:升序, -1:倒序 |
| limit | 是 | 排名量 |
| fineness | 是 | 统计粒度, 见[附录](#snapshot_statistic_rule_fineness)。 |

**Response**

Header

	HTTP/1.1 200 OK

Content

	{
	    "mode": "端点统计方式",
		"fineness":"统计粒度",
	    "list": [
	        {
	            "device_id": 1235566,
				"datapoint":"数据端点",
	            "value": 152.6
	        },
	        {
	            "device_id": 1235566,
				"datapoint":"数据端点",
	            "value": 152.6
	        }
	    ]
	}

| 字段 | 是否必须 | 描述 |
| --- | --- | --- |
| mode | 是 | 统计方式, 见[附录](#snapshot_statistic_rule_mode)。 |
| list | 是 | 符合排名的数据 |
| device_id | 是 | 设备id |
| datapoint | 是 | 数据端点下标 |
| value | 是 | 统计维度下的值 |


### <a name="#statistics_snapshot_device_rank">4.产品下获取设备数据端点的排名</a>

	产品下设备在一个统计维度某段时间数据快照值排名统计(自身排名)
	
**Request**

URL
	
	POST /v2/statistics/snapshot/{snapshot_id}/snapshot_rank/{snapshot_statistic_id}/{device_id}
Header

	Content-Type:"application/json"
	Access-Token:"调用凭证"

Content

	{
		"datapoint": [
			"数据端点1",
			"数据端点2",
			"数据端点3"
		],
		"mode": "端点统计方式",
		"date_start": "快照统计数据开始时间, 格式为yyyy-MM-dd'T'HH:mm:ss.SS'Z'",
		"date_end": "快照统计数据结束时间, 格式为yyyy-MM-dd'T'HH:mm:ss.SS'Z'",
		"sort": "排名方式, 1:升序, -1:倒序",
		"fineness":"统计粒度"
	}

| 字段 | 是否必须 | 描述 |
| --- | --- | --- |
| datapoint | 是 | 要进行的数据端点列表, 数据端点必须在统计规则中有进行设置, 目前仅支持单个数据端点统计 |
| mode | 是 | 数据端点统计方式, 见[附录](#snapshot_statistic_rule_mode) |
| date_start | 是 | 快照统计数据开始时间 |
| date_end | 是 | 快照统计数据结束时间 |
| sort | 是 | 排名方式, 1:升序, -1:倒序 |
| fineness | 是 | 统计粒度, 见[附录](#snapshot_statistic_rule_fineness)。 |

**Response**

Header

	HTTP/1.1 200 OK

Content

	{
		"mode": "端点统计方式",
		"list": [
			{
				"datapoint":"数据端点",
				"position": 2
			},
			{
				"datapoint":"数据端点",
				"position": 5
			}
		]
	}

| 字段 | 是否必须 | 描述 |
| --- | --- | --- |
| mode | 是 | 统计方式, 见[附录](#snapshot_statistic_rule_mode)。 |
| list | 是 | 各个数据端点排名的数据 |
| datapoint | 是 | 数据端点下标 |
| position | 是 | 排名 |


### <a name="#statistics_datapoint_classify">5.产品下数据端点分类统计</a>

	产品下数据端点的分类统计, 统计处于某一数据端点值的设备总数
	
**Request**

URL
	
	POST /v2/statistics/product/{product_id}/datapoint/classify
Header

	Content-Type:"application/json"
	Access-Token:"调用凭证"

Content

	{
	    "index": "数据端点下标",
	    "key": [
			"分类值",
			"分类值",
			"分类值"
	    ]
	}

| 字段 | 是否必须 | 描述 |
| --- | --- | --- |
| index | 是 | 数据端点下标 |
| key | 是 | 数据端点分类值列表 |

**Response**

Header

	HTTP/1.1 200 OK

Content

	{
	    "list": [
			{
			    "key": "分类值",
			    "count": "分类总计值"
			},
			{
			    "key": "分类值",
			    "count": "分类总计值"
			}
	    ]
	}

| 字段 | 是否必须 | 描述 |
| --- | --- | --- |
| key | 是 | 数据端点分类值列表 |
| count | 是 | 处于key类值的设备总数 |

### <a name="statistics_product_datapoint">6.产品维度数据端点统计</a>

	产品下基于某一快照规则对某一数据端点进行统计
	
**Request**

URL
	
	POST /v2/statistics/product/{product_id}/snapshot_datapoint/{snapshot_id}

Header

	Content-Type:"application/json"
	Access-Token:"调用凭证"

Content

	{
	    "index": "数据端点下标",
	    "date_start": "快照统计数据开始时间, 格式为yyyy-MM-dd'T'HH:mm:ss.SS'Z'",
	    "date_end": "快照统计数据结束时间, 格式为yyyy-MM-dd'T'HH:mm:ss.SS'Z'",
	    "mode":[
		1,
		2
	    ]
	}

| 字段 | 是否必须 | 描述 |
| --- | --- | --- |
| index | 是 | 数据端点下标 |
| date_start | 是 | 快照统计数据开始时间 |
| date_end | 是 | 快照统计数据结束时间 |
| mode | 是 | 数据端点统计方式, 见[附录](#snapshot_statistic_rule_mode) |

**Response**

Header

	HTTP/1.1 200 OK

Content

	{
	    "product_id":"产品id",
	    "snapshot_id":"快照规则id",
	    "index":"数据端点下标",
	    "max":"最大值, 请求参数mode包含1时返回",
	    "min":"最小值, 请求参数mode包含2时返回",
	    "avg":"平均值, 请求参数mode包含3时返回",
	    "sum":"和, 请求参数mode包含4时返回"
	}

| 字段 | 是否必须 | 描述 |
| --- | --- | --- |
| product_id | 是 | 产品id |
| snapshot_id | 是 | 快照规则id |
| index | 是 | 数据端点下标 |
| max | 是 | 最大值, 请求参数mode包含1时返回 |
| min | 是 | 最小值, 请求参数mode包含2时返回 |
| avg | 是 | 平均值, 请求参数mode包含3时返回 |
| sum | 是 | 和, 请求参数mode包含4时返回 |


### <a name="corp_get_vdevice_info">7. 获取虚拟设备数据</a>

#### **Request**

*URL*

```
GET /v2/product/{product_id}/v_device/{device_id}
```

*Header*

```
Content-Type:application/json
Access-Token:"企业调用凭证"
```

*Content*

```
无
```

#### **Response**

*Header*

```
HTTP/1.1 200 OK
```

*Content*

```
{
    "0": "数据端点值",
    "1": "数据端点值",
    "device_id": "设备ID",
    "cm_id": "登录CM服务器ID",
    "ip": "登录IP",
    "online": "是否在线",
    "last_login": "上次登录时间,例：2015-10-09T08:15:40.843Z",
    "last_logout": "上次离线时间,例：2015-10-09T08:15:40.843Z",
    "last_update": "上次数据端点变化时间,例：2015-10-09T08:15:40.843Z",
    "online_count": "累计在线时长"
}
```

| 名称 | 是否必须 | 值 |
| --- | --- | --- |
| device_id | 是 | 设备ID |
| cm_id | 是 | 登录CM服务器ID |
| ip | 是 | 登录IP |
| online | 是 | 是否在线 |
| last_login | 是 | 上次登录时间,例：2015-10-09T08:15:40.843Z|
| last_logout | 是 | 上次离线时间,例：2015-10-09T08:15:40.843Z |
| last_update | 是 | 上次数据端点变化时间,例：2015-10-09T08:15:40.843Z |
| online_count | 是 | 设备累计在线时长，单位：秒
| 数据端点索引 | 否 | 数据端点值 |


### <a name="corp_get_vdevice_list">8.批量获取虚拟设备数据</a>

#### **Request**

*URL*

```
POST /v2/product/{product_id}/v_devices
```

*Header*

```
Content-Type:application/json
Access-Token:"企业调用凭证"
```

*Content*

```
[device_id,device_id,device]
```

#### **Response**

*Header*

```
HTTP/1.1 200 OK
```

*Content*

```
{
    "list": [
        {
            "0": "数据端点值",
            "1": "数据端点值",
            "device_id": "设备ID",
            "cm_id": "登录CM服务器ID",
            "ip": "登录IP",
            "online": "是否在线",
            "last_login": "上次登录时间,例：2015-10-09T08:15:40.843Z",
            "last_logout": "上次离线时间,例：2015-10-09T08:15:40.843Z",
            "last_update": "上次数据端点变化时间,例：2015-10-09T08:15:40.843Z",
			"online_count": "累计在线时长"
        }
    ]
}
```

| 名称 | 是否必须 | 值 |
| --- | --- | --- |
| device_id | 是 | 设备ID |
| cm_id | 是 | 登录CM服务器ID |
| ip | 是 | 登录IP |
| online | 是 | 是否在线 |
| last_login | 是 | 上次登录时间,例：2015-10-09T08:15:40.843Z|
| last_logout | 是 | 上次离线时间,例：2015-10-09T08:15:40.843Z |
| last_update | 是 | 上次数据端点变化时间,例：2015-10-09T08:15:40.843Z |
| online_count | 是 | 设备累计在线时长，单位：秒
| 数据端点索引 | 否 | 数据端点值 |


### 2.对应的枚举

### <a name="snapshot_statistic_rule_mode">快照统计方式</a>

| 名称 | 值 | 说明 |
| --- | --- | --- |
| max | 1 | 最大值 |
| min | 2 | 最小值 |
| avg | 3 | 平均值 |
| sum | 4 | 和 |

### <a name="snapshot_statistic_rule_fineness">快照统计粒度</a>

| 名称 | 值 | 说明 |
| --- | --- | --- |
| hour | 1 | 小时 |
| day | 2 | 天 |
| week | 3 | 周 |
| month | 4 | 月 |
| year | 5 | 年 |

©2016  **云智易**物联云平台（http://www.xlink.cn）